<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exploring Included Subject Freesurfer Data • freesurfer</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Exploring Included Subject Freesurfer Data">
<meta property="og:description" content="freesurfer">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">freesurfer</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.6.7.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/exploring_included_data.html">Exploring Included Subject Freesurfer Data</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/muschellij2/freesurfer/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="exploring_included_data_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Exploring Included Subject Freesurfer Data</h1>
                        <h4 data-toc-skip class="author">Vignette Author</h4>
            
            <h4 data-toc-skip class="date">2021-05-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/muschellij2/freesurfer/blob/master/vignettes/exploring_included_data.Rmd" class="external-link"><code>vignettes/exploring_included_data.Rmd</code></a></small>
      <div class="hidden name"><code>exploring_included_data.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor" aria-hidden="true"></a>Introduction</h1>
<p></p>
<p>Freesurfer is a commonly-used software for processing and analyzing anatomical neuroimaging data , developed by the Laboratory for Computational Neuroimaging at the Athinoula A. Martinos Center for Biomedical Imaging. This software provides open-source, command-line tools for image processing tasks such as brain extraction/skull-stripping , bias-field correction , segmentation of structures within the brain , and image registration . In addition to these functions, Freesurfer has functions that perform fully-automated pipelines for the user.</p>
<!-- We have previously published a similar adaptation of the FSL imaging software \citep{jenkinson_fsl_2012} to R, called \CRANpkg{fslr} \citep{muschelli2015fslr}.   
Again, we note that there -->
<p>There exist a number of R packages for reading and manipulating image data, including   and  , which analyze functional magnetic resonance images (MRI) and perform spatial smoothing,  , which performs image registration, and   and  , which perform image clustering and segmentation (see the Medical Imaging CRAN task view  for more information). These packages provide powerful tools for performing image analysis, but the neuroimaging community has additional tools that may perform better on a specific data set or provide more information than these R packages. Freesurfer provides methods that are not currently implemented in R, including surface-based registration and completely automated image segmentation pipelines. The  package () is a currently unpublished R package where additional image analysis functionality has been implemented, but does not include all the functionality Freesurfer has. Moreover, having multiple options for image processing through R enables users to compare methods and provides the flexibility of using multiple packages to achieve a working data processing pipeline.</p>
<p>We provide an interface to users to the state-of-the-art anatomical processing implemented in Freesurfer, as well as a suite of tools that simplify analyzing the output of Freesurfer. The  package allows R users to perform a complete anatomical imaging analyses without necessarily learning Freesurfer-specific syntax, while keeping both the image processing and analysis within R.</p>
<div id="r-function-setup" class="section level2">
<h2 class="hasAnchor">
<a href="#r-function-setup" class="anchor" aria-hidden="true"></a>R function setup</h2>
<p>To use , a working installation of Freesurfer is required (downloads available: ). The following code was run using Freesurfer version “NA”. The Freesurfer version can be accessed using the   function. The path of Freesurfer must also be set. When using R from a shell environment, after the  environment variable is set (which is done when installing Freesurfer),  will use this as the path to Freesurfer. If using R through a graphical user interface (GUI) such as RStudio (RStudio, Boston, MA), environmental variables and paths are not explicitly exported. Therefore,  is not set and  will try the default directories of Mac OSX and Linux. Freesurfer is only available on Windows via a virtual machine. If the user did not perform an standard installation of Freesurfer, the path to Freesurfer can be specified using . The  function tests whether a user has a Freesurfer installation, returning a logical, which is useful for  statements within examples. If  function returns is , the  function will return the directory of the Freesurfer installation.</p>
<div id="structure-of-freesurfer-analyses" class="section level3">
<h3 class="hasAnchor">
<a href="#structure-of-freesurfer-analyses" class="anchor" aria-hidden="true"></a>Structure of Freesurfer analyses</h3>
<p>During the installation of Freesurfer, environment variables in addition to  are set. One of these variables is , which refers to a directory of the output of analysis from all subjects. The  function will return the path to the Freesurfer subjects directory if it is set. This default setup of a subjects directory in Freesurfer allows users to simply specify a subject identifier to analyze, rather than a specific path or multiple intermediate files.</p>
<p>This setup may not be desirable if the user prefers to structure his or her data differently. For example, if data from multiple studies are present, these may be organized into different folders in different locations. Some functions in Freesurfer rely on the  variable to run. These functions take the subject name as the main argument rather than a file, which is more common. To provide flexibility to the user,  allows most functions to specify a file or different directory rather than specifying the subject.</p>
<p>One example is the  Freesurfer function. Freesurfer performs segmentations of the anatomical image into different structures and has associated statistics for each region such as volume and mean intensity. The  function transforms <strong>a</strong>natomical <strong>seg</strong>mentation <strong>stat</strong>istics from images into to a table. The default argument for  is to pass in a subject name rather than a file. The   function allows the R user to specify the subject name, but also allows the user to alternatively specify a file name instead. This function will temporarily set  to a temporary directory, copy the file to that directory, execute the command, then reset the  variable. This provides a more flexible workflow, while not overriding the default directory set in . This functionality allows users to have separate folders with subjects and read in the data by simply switching the  argument in the R function.</p>
</div>
</div>
<div id="reconstruction-pipeline-in-freesurfer" class="section level2">
<h2 class="hasAnchor">
<a href="#reconstruction-pipeline-in-freesurfer" class="anchor" aria-hidden="true"></a>Reconstruction pipeline in Freesurfer</h2>
<p>The Freesurfer pipeline and analysis workflow for neuroanatomical images is designed to work with T1-weighted structural MRI of the brain. The full pipeline is implemented in the Freesurfer  function, where the “recon” stands for reconstruction (). The <code>recon-all</code> function is the main workhorse of Freesurfer and is the most commonly used. Using the  flag in the the  function performs over 30 different steps and takes 20-40 hours to fully process a subject (<a href="https://surfer.nmr.mgh.harvard.edu/fswiki/recon-all" class="external-link">https://surfer.nmr.mgh.harvard.edu/fswiki/recon-all</a>). This process is the recommended way of fully processing an T1-weighted image in Freesurfer, and is implemented in the <code>recon_all</code>  function.</p>
<p>In the <code>recon_all</code> function, users must specify the input file (a T1-weighted image), the output directory (if different than ), and the subject identifier. The results will be written in the individual subject directory, a sub-directory of . The syntax is:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/recon_all.html">recon_all</a></span><span class="op">(</span><span class="va">infile</span>, <span class="va">outdir</span>, <span class="va">subjid</span><span class="op">)</span></code></pre></div>
<p>If there are problems with the result of this processing, there are multiple steps where users can edit certain parts of the processing, such as brain extraction, where non-brain tissues are removed from the image. The remainder of the pipeline can be run after these steps are corrected. The full pipeline is broken down into 3 separate sets of steps, referred to as , , and , which correspond to the same-named flags in  used to initiate these steps. We have written wrapper functions , , and , respectively, so users can run pieces of the pipeline if desired or restart a failed process after correction to the data.</p>
<!-- \section{\pkg{fslr} workflow} -->
<!-- The general workflow for most \pkg{fslr} functions that interface with FSL is as follows: -->
<!-- \begin{enumerate} -->
<!-- \item Filename or \code{nifti} object is passed to \pkg{fslr} function. -->
<!-- \item FSL command is created within \pkg{fslr} function and executed using the \code{system} command. -->
<!-- \item Output is written to disk and/or read into R and returned from the function. -->
<!-- \end{enumerate} -->
</div>
<div id="imaging-formats-in-and-r" class="section level2">
<h2 class="hasAnchor">
<a href="#imaging-formats-in-and-r" class="anchor" aria-hidden="true"></a>Imaging formats in  and R</h2>
<p>The  package relies on the   package implementation of images (referred to as  objects) that are in the Neuroimaging Informatics Technology Initiative (NIfTI) format. For Freesurfer functions that require an image, the R  functions that call those Freesurfer functions will take in a file name or a  object. The R code will convert the  to the corresponding input required for Freesurfer. From the user’s perspective, the input/output process is all within R, with one object format (). The advantage of this approach is that the user can read in an image, do manipulations of the  object using standard syntax for arrays, and pass this object into the  R function. Thus, users can use R functionality to manipulate objects while seamlessly passing these object to Freesurfer through .</p>
<p>Other Freesurfer functions require imaging formats other than NIfTI, such as the Medical Imaging NetCDF (MINC) format (). The Freesurfer installation provides functions to convert from MINC to NIfTI formats and these are implemented in functions such as  and  in R. Moreover, the  Freesurfer function has been interfaced in  (same function name), which allows for a more general conversion tool of imaging types for R users than currently implemented in native R. Thus, many formats can be converted to NIfTI and then read into R using the  function from .</p>
</div>
</div>
<div id="example-analyses-and-use-of-functions" class="section level1">
<h1 class="hasAnchor">
<a href="#example-analyses-and-use-of-functions" class="anchor" aria-hidden="true"></a>Example analyses and use of functions</h1>
<div id="reconstruction" class="section level2">
<h2 class="hasAnchor">
<a href="#reconstruction" class="anchor" aria-hidden="true"></a>Reconstruction</h2>
<p>For this paper, we will not run the analysis on a subject, but rather explore the output results for a subject included in the Freesurfer installation for reproducibility for the user. In particular, in the default Freesurfer subjects directory, there is a subject named “bert”. If we were to run all the analyses, we would use the  code (described below):</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/recon_all.html">recon_all</a></span><span class="op">(</span>infile <span class="op">=</span> <span class="st">"/path/to/T1.nii"</span>, subjid <span class="op">=</span> <span class="st">"bert"</span><span class="op">)</span></code></pre></div>
<p>We see the result of this output in the “bert” directory, which includes a series of sub-directories:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/have_fs.html">have_fs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span>path  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="../reference/fs_subj_dir.html">fs_subj_dir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"bert"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We will explore the results in “mri”, which contain imaging data, “stats”, which containing statistics based on structures of the brain, and “surf”, which contain the surface and curvature output from the Freesurfer processing.</p>
</div>
<div id="mri-conversion-the-function" class="section level2">
<h2 class="hasAnchor">
<a href="#mri-conversion-the-function" class="anchor" aria-hidden="true"></a>MRI conversion: the  function</h2>
<p>The typical output format of brain volumes from Freesurfer is MGH/MGZ format, which is explained here: . As NIfTI formats are one of the most common formats and has been the common format for analysis in the  and  packages, it is useful to convert these files to a NIfTI format to read into R. The  Freesurfer function will be used for that conversion. Here we will use the T1-weighted image from the “bert” subject and convert it to NIfTI, and read it into R:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">freesurfer</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/have_fs.html">have_fs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">bert_dir</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="../reference/fs_subj_dir.html">fs_subj_dir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"bert"</span><span class="op">)</span> <span class="co"># subject directory</span>
  <span class="va">t1_mgz</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">bert_dir</span>, <span class="st">"mri"</span>, <span class="st">"T1.mgz"</span><span class="op">)</span> <span class="co"># mgz file</span>
  <span class="va">t1_nii_fname</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".nii.gz"</span><span class="op">)</span> <span class="co"># temporary NIfTI file</span>
  <span class="fu">freesurfer</span><span class="fu">::</span><span class="fu"><a href="../reference/mri_convert.html">mri_convert</a></span><span class="op">(</span><span class="va">t1_mgz</span>, <span class="va">t1_nii_fname</span><span class="op">)</span> <span class="co"># conversion</span>
  <span class="va">img</span> <span class="op">=</span> <span class="fu">neurobase</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html" class="external-link">readnii</a></span><span class="op">(</span><span class="va">t1_nii_fname</span><span class="op">)</span> <span class="co"># read in outputs</span>
<span class="op">}</span></code></pre></div>
<p>As this is a commonly-used process, we have wrapped these two steps into the <code>readmgz</code> and <code>readmgh</code> functions, which combine the <code>mri_convert</code> and <code>readnii</code> functions. Here we show that these steps are equivalent to the <code>readmgz</code> function:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/have_fs.html">have_fs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">img_mgz</span> <span class="op">=</span> <span class="fu"><a href="../reference/readmgz.html">readmgz</a></span><span class="op">(</span><span class="va">t1_mgz</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">img</span>, <span class="va">img_mgz</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Now that we have the image in R, we can plot it using the standard plotting tools for <code>nifti</code> objects:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/have_fs.html">have_fs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">neurobase</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/ortho2.html" class="external-link">ortho2</a></span><span class="op">(</span><span class="va">img</span>, add.orient <span class="op">=</span> <span class="cn">FALSE</span>, mask <span class="op">=</span> <span class="va">img</span> <span class="op">&gt;</span> <span class="fl">40</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The result is in figure , which contains 3 slices of the head: axially, viewing the brain from the top of the head (top left), sagittally, viewing the brain from the right side (top right) and coronally, viewing the brain from the back of the head (bottom left).</p>
<p>Note, the image is not stored in the right/posterior/inferior (RPI) orientation which is assumed when displaying using the   function <a href="http://www.grahamwideman.com/gw/brain/orientation/orientterms.htm" class="external-link">http://www.grahamwideman.com/gw/brain/orientation/orientterms.htm</a>. We can use the <code>rpi_orient</code> function in  (version <span class="math inline">\(\geq\)</span> 2.4.0)  or <code>fslswapdim</code> to reorient the image to the assumed orientation.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/have_fs.html">have_fs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu">fslr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fslr/man/have.fsl.html" class="external-link">have_fsl</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">L</span> <span class="op">=</span> <span class="fu">fslr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fslr/man/rpi_orient.html" class="external-link">rpi_orient</a></span><span class="op">(</span><span class="va">img</span><span class="op">)</span>
    <span class="va">reoriented_img</span> <span class="op">=</span> <span class="va">L</span><span class="op">[[</span><span class="st">"img"</span><span class="op">]</span><span class="op">]</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">reoriented_img</span> <span class="op">=</span> <span class="va">img</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>We see that this function puts this image in the RPI orientation, which matches the assumed orientation for <code>ortho2</code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/have_fs.html">have_fs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">neurobase</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/ortho2.html" class="external-link">ortho2</a></span><span class="op">(</span><span class="va">reoriented_img</span>, mask <span class="op">=</span> <span class="va">reoriented_img</span> <span class="op">&gt;</span> <span class="fl">40</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The result is in figure , which changes the views in reference to which panel they are located and matches the orientation markers assumed by .</p>
</div>
<div id="bias-field-correction-the-function" class="section level2">
<h2 class="hasAnchor">
<a href="#bias-field-correction-the-function" class="anchor" aria-hidden="true"></a>Bias-field correction: the  function</h2>
<p>MRI images typically exhibit good contrast between soft tissue classes, but intensity inhomogeneities in the radio frequency field can cause differences in the ranges of tissue types at different spatial locations (e.g. top versus bottom of the brain). These inhomogeneities/non-uniformities can cause problems with algorithms based on histograms, quantiles, or raw intensities . Therefore, correction for image inhomogeneities is a crucial step in many analyses. The Freesurfer function  performs the non-uniformity correction by , and the  function of the same name will run the correction and return an image.</p>
<p>The Freesurfer  function requires a MINC format (). For this to work, you can convert the  object to a MINC file using :</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/have_fs.html">have_fs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">mnc</span> <span class="op">=</span> <span class="fu"><a href="../reference/nii2mnc.html">nii2mnc</a></span><span class="op">(</span><span class="va">reoriented_img</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">mnc</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We can pass this MINC file into the   function, which will run the correction and then convert the output MNC to a NIfTI object.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/have_fs.html">have_fs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">nu_from_mnc</span> <span class="op">=</span> <span class="fu"><a href="../reference/nu_correct.html">nu_correct</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">mnc</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">nu_from_mnc</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We see that the results are indeed  objects. We can plot the estimated bias field (log-transformed for display purposes) side-by-side with the image to view which areas had been differentially corrected (Figure ).</p>
<p>In addition to the  and  functions above, we have a  wrapper function for reading in MINC files, after conversion to NIfTI files. If you pass in a  object in directly into <code>nu_correct</code>, the function will automatically convert any NIfTI input files, and then run the correction (shown below). We can also pass in a mask of the brain (see next section) to run the correction only the areas of the brain.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/have_fs.html">have_fs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">nu_masked</span> <span class="op">=</span> <span class="fu"><a href="../reference/nu_correct.html">nu_correct</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">reoriented_img</span>, mask <span class="op">=</span> <span class="va">mask</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Overall, this correction is a way to make the intensities of the brain more homogeneous spatially. This method is different from that implemented in FSL  (and therefore ), so it provides an alternative method to the R user than currently available.</p>
</div>
<div id="brain-extraction-the-function" class="section level2">
<h2 class="hasAnchor">
<a href="#brain-extraction-the-function" class="anchor" aria-hidden="true"></a>Brain extraction: the  function</h2>
<p>The  function will segment the brain from the remainder of the image, such as extra-cranial tissues. Other imaging software in R have implemented the watershed algorithm, such as  . These methods have not been directly adapted for MRI nor specifically for brain extraction. In , we can pass in the  object and the output is a brain-extracted  object.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/have_fs.html">have_fs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">ss</span> <span class="op">=</span> <span class="fu"><a href="../reference/mri_watershed.html">mri_watershed</a></span><span class="op">(</span><span class="va">img</span><span class="op">)</span>
  <span class="fu">ortho2</span><span class="op">(</span><span class="va">ss</span>, mask <span class="op">=</span> <span class="va">ss</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The result is in figure , where we see areas of the skull, eyes, face, and other areas of the image are removed. We do see some areas remain that may be part of some of the membranes between the brain and the skull, but this looks like an adequate brain extraction for most analyses.</p>
<p>As the result is a  object, we can create a mask by standard logical operations for arrays. As MRI scans are typically positive-valued, the positive areas of the image are the “brain”:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/have_fs.html">have_fs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">mask</span> <span class="op">=</span> <span class="va">ss</span> <span class="op">&gt;</span> <span class="fl">0</span>
<span class="op">}</span></code></pre></div>
<p>We can then use this mask to perform operations on the image, such as subsetting.</p>
</div>
<div id="segmentations-of-brain-structures" class="section level2">
<h2 class="hasAnchor">
<a href="#segmentations-of-brain-structures" class="anchor" aria-hidden="true"></a>Segmentations of brain structures</h2>
<p>Freesurfer is commonly used to segment cortical and subcortical structures of the brain. We can visualize images of these segmentations, which are located in the “mri” folder. We will choose the colors based on the Freesurfer look up table (LUT), which values can be explored at <a href="https://surfer.nmr.mgh.harvard.edu/fswiki/FsTutorial/AnatomicalROI/FreeSurferColorLUT" class="external-link">https://surfer.nmr.mgh.harvard.edu/fswiki/FsTutorial/AnatomicalROI/FreeSurferColorLUT</a>. This look up table provides a label for each structure and the color associated with it:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/have_fs.html">have_fs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">freesurfer</span><span class="fu">::</span><span class="va"><a href="../reference/fs_lut.html">fs_lut</a></span>, <span class="fl">3</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>This object is included in  and denotes the indices, labels, and color representation of the structure. We note that the alpha channel is set to <span class="math inline">\(0\)</span> for all regions of interest, so we will not use it in the calculation of the colors from RGB space. This LUT allows visualizations produced in R to be consistent with those from Freesurfer.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/have_fs.html">have_fs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">seg_file</span> <span class="op">=</span> <span class="va">file</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="../reference/fs_subj_dir.html">fs_subj_dir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"bert"</span>, <span class="st">"mri"</span>, <span class="st">"aseg.mgz"</span><span class="op">)</span>
  <span class="va">seg</span> <span class="op">=</span> <span class="fu"><a href="../reference/readmgz.html">readmgz</a></span><span class="op">(</span><span class="va">seg_file</span><span class="op">)</span>
  <span class="va">breaks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="va">fs_lut</span><span class="op">$</span><span class="va">index</span><span class="op">)</span>
  <span class="va">colors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="va">fs_lut</span><span class="op">$</span><span class="va">R</span>, <span class="va">fs_lut</span><span class="op">$</span><span class="va">G</span>, <span class="va">fs_lut</span><span class="op">$</span><span class="va">B</span>, alpha <span class="op">=</span> <span class="fl">255</span><span class="op">/</span><span class="fl">2</span>, maxColorValue <span class="op">=</span> <span class="fl">255</span><span class="op">)</span>
  <span class="fu">ortho2</span><span class="op">(</span><span class="va">ss</span>, <span class="va">seg</span>, col.y <span class="op">=</span> <span class="va">colors</span>, ybreaks <span class="op">=</span> <span class="va">breaks</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Note above that the number of breaks must be one larger than the number of colors and the indices start at zero, so we add an additional element to the indices. The result in figure  shows the image with colors overlaid.</p>
</div>
<div id="reading-in-anatomical-statistics-for-brain-structures" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-in-anatomical-statistics-for-brain-structures" class="anchor" aria-hidden="true"></a>Reading in anatomical statistics for brain structures</h2>
<p>We have explored the spatial results in the brain images, but not the quantitative information about the brain and sub-structures that are available from Freesurfer output. The “aseg.stats” in the “stats” folder for subject bert corresponds to measures and statistics from the anatomical segmentation. The  function reads this corresponding file and creates a list of 2 different s:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/have_fs.html">have_fs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">file</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="../reference/fs_subj_dir.html">fs_subj_dir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"bert"</span>, <span class="st">"stats"</span>, <span class="st">"aseg.stats"</span><span class="op">)</span>
  <span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_aseg_stats.html">read_aseg_stats</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The  element corresponds to global measurements of the brain (e.g. volume of the brain) as well as measures of gross anatomical structures (e.g. gray matter).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/have_fs.html">have_fs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">measures</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"meaning"</span>, <span class="st">"value"</span>, <span class="st">"units"</span><span class="op">)</span><span class="op">]</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>In some imaging analyses, comparing at these large measures of brain volume over time or across groups are of interest. Alternatively, the  element corresponds to a set of measures and statistics for a set of fixed anatomical structures.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/have_fs.html">have_fs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">structures</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Similarly with global measures, these structure-specific measures are used in analysis. For example, measuring differences in hippocampus volumes across patients with Alzheimer’s disease and those without. Moreover, a large deviation in volume, globally or locally, for a specific subject may indicate atrophy of a structure or an indication of a segmentation error.</p>
</div>
<div id="converting-surfaces-using" class="section level2">
<h2 class="hasAnchor">
<a href="#converting-surfaces-using" class="anchor" aria-hidden="true"></a>Converting surfaces using </h2>
<p>Freesurfer includes segmentations of different surfaces of the brain alongside the volumetric segmentations above. As the  function provides a tool to convert image volumes to a series of output formats, the  (note the “s”) allows users to convert between image surface formats. These surfaces usually store sets of vertices and faces to be plotted in 3 dimensions.  has implemented  (with a function of the same name) as well as functions to convert surfaces from Freesurfer to a set of triangles in R, such as <code>surface_to_triangles</code>. We will read in the left and right side of the pial surface of the brain and display the surface using  .</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/have_fs.html">have_fs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">right_file</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="../reference/fs_subj_dir.html">fs_subj_dir</a></span><span class="op">(</span><span class="op">)</span>, 
                   <span class="st">"bert"</span>, <span class="st">"surf"</span>, <span class="st">"rh.pial"</span><span class="op">)</span>
  <span class="va">right_triangles</span> <span class="op">=</span> <span class="fu"><a href="../reference/surface_to_triangles.html">surface_to_triangles</a></span><span class="op">(</span>infile <span class="op">=</span> <span class="va">right_file</span><span class="op">)</span>
  <span class="va">left_file</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="../reference/fs_subj_dir.html">fs_subj_dir</a></span><span class="op">(</span><span class="op">)</span>, 
                     <span class="st">"bert"</span>, <span class="st">"surf"</span>, <span class="st">"lh.pial"</span><span class="op">)</span>
  <span class="va">left_triangles</span> <span class="op">=</span> <span class="fu"><a href="../reference/surface_to_triangles.html">surface_to_triangles</a></span><span class="op">(</span>infile <span class="op">=</span> <span class="va">left_file</span><span class="op">)</span> 
  <span class="fu">rgl</span><span class="fu">::</span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/rgl.open.html" class="external-link">rgl.open</a></span><span class="op">(</span><span class="op">)</span>
  <span class="fu">rgl</span><span class="fu">::</span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/primitive.html" class="external-link">rgl.triangles</a></span><span class="op">(</span><span class="va">right_triangles</span>, 
                     color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">rainbow</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">right_triangles</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="fu">rgl</span><span class="fu">::</span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/primitive.html" class="external-link">rgl.triangles</a></span><span class="op">(</span><span class="va">left_triangles</span>, 
                     color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">rainbow</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">left_triangles</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Thus, we can read in the output images, surfaces, and the tables of output metrics from Freesurfer.</p>
</div>
<div id="additional-features" class="section level2">
<h2 class="hasAnchor">
<a href="#additional-features" class="anchor" aria-hidden="true"></a>Additional features</h2>
<p>For the initial release, we did not implement a method to read the annotation files and other surface-based files that Freesurfer uses. Reading in these files are planned for a future release and may work with the functions described above. Freesurfer can also analyze diffusion tensor imaging data and some of the functions have been adapted for  but have not been thoroughly tested.</p>
</div>
</div>
<div id="conclusion" class="section level1">
<h1 class="hasAnchor">
<a href="#conclusion" class="anchor" aria-hidden="true"></a>Conclusion</h1>
<p>The neuroimaging community has developed a large collection of tools for image processing and analysis. These tools have additional functionality that is not present in R, such as the surface-based registration and processing Freesurfer provides. We have provided a similar incorporation of tools from FSL to R in the  package and have repeated the effort for Freesurfer with the  package to bridge this gap and provide R users functions from Freesurfer.</p>
<p>There has been an increasing popularity of similar interfacing of tools within the Python community such as Nipype  (<a href="https://qa.debian.org/popcon.php?package=nipype" class="external-link uri">https://qa.debian.org/popcon.php?package=nipype</a>). As many users of R may not have experience with Python or bash scripting, we believe  provides a lower threshold for use in the R community.</p>
<p>Lowering this threshold is important because it allows more R users to control all aspects of image analysis from raw image processing to final statistical analysis. Interfacing R with existing, powerful software provides R users more functionality and a additional support community, which would not be available if the functions were rewritten in R. Although having an external software dependency may be disadvantage to R users, the software used benefits from the years of previous testing. Most importantly, as  is based on the R framework, all the benefits of using R are available, such as dynamic documents, Shiny applications, customized figures, and state-of-the-art statistical methods. This added functionality affords the neuroimaging and R communities the ability to have analysis in one framework while borrowing the strengths of both.</p>
</div>
<div id="supplemental-material" class="section level1">
<h1 class="hasAnchor">
<a href="#supplemental-material" class="anchor" aria-hidden="true"></a>Supplemental material</h1>
<div id="label-files" class="section level2">
<h2 class="hasAnchor">
<a href="#label-files" class="anchor" aria-hidden="true"></a>Label files</h2>
<p>Although we have not thoroughly tested reading in a label file from Freesurfer, we have provided the  function. Here we will read a label file for the left hemisphere cortex:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/have_fs.html">have_fs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">file</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="../reference/fs_subj_dir.html">fs_subj_dir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"bert"</span>, <span class="st">"label"</span>, <span class="st">"lh.cortex.label"</span><span class="op">)</span>
  <span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_fs_label.html">read_fs_label</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The coordinates are mostly used in these files, not the value assigned (in this case all zeroes). These files can be used for registration as well. Overall, we have provided a reader for users, but have not used them in our research and therefore have not tested them extensively to discuss them further.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by John Muschelli.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
